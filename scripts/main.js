"use strict";window.DOMHandler=class{constructor(e,t){this._iRuntime=e,this._componentId=t,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(e,t,n,a){this._iRuntime.PostToRuntimeComponent(this._componentId,e,t,n,a)}PostToRuntimeAsync(e,t,n,a){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,e,t,n,a)}_PostToRuntimeMaybeSync(e,t,n){this._iRuntime.UsesWorker()?this.PostToRuntime(e,t,n):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:e,dispatchOpts:n||null,data:t,responseId:null})}AddRuntimeMessageHandler(e,t){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,e,t)}AddRuntimeMessageHandlers(e){for(const[t,n]of e)this.AddRuntimeMessageHandler(t,n)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(e,t){this._callback=e,this._interval=t,this._timerId=-1,this._lastCallTime=-Infinity,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(e){this._canRunImmediate=!!e}Call(){if(-1===this._timerId){const e=Date.now(),t=e-this._lastCallTime,n=this._interval;t>=n&&this._canRunImmediate?(this._lastCallTime=e,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(n-t,4))}}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}},"use strict",window.DOMElementHandler=class extends DOMHandler{constructor(e,t){super(e,t),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandler("create",e=>this._OnCreate(e)),this.AddRuntimeMessageHandler("destroy",e=>this._OnDestroy(e)),this.AddRuntimeMessageHandler("set-visible",e=>this._OnSetVisible(e)),this.AddRuntimeMessageHandler("update-position",e=>this._OnUpdatePosition(e)),this.AddRuntimeMessageHandler("update-state",e=>this._OnUpdateState(e)),this.AddRuntimeMessageHandler("focus",e=>this._OnSetFocus(e)),this.AddRuntimeMessageHandler("set-css-style",e=>this._OnSetCssStyle(e))}SetAutoAttach(e){this._autoAttach=!!e}AddDOMElementMessageHandler(e,t){this.AddRuntimeMessageHandler(e,e=>{const n=e.elementId,a=this._elementMap.get(n);return t(a,e)})}_OnCreate(e){const t=e.elementId,n=this.CreateElement(t,e);this._elementMap.set(t,n),e.isVisible||(n.style.display="none"),this._autoAttach&&document.body.appendChild(n)}CreateElement(){throw new Error("required override")}DestroyElement(){}_OnDestroy(e){const t=e.elementId,n=this._elementMap.get(t);this.DestroyElement(n),this._autoAttach&&n.parentElement.removeChild(n),this._elementMap.delete(t)}PostToRuntimeElement(e,t,n){n||(n={}),n.elementId=t,this.PostToRuntime(e,n)}_PostToRuntimeElementMaybeSync(e,t,n){n||(n={}),n.elementId=t,this._PostToRuntimeMaybeSync(e,n)}_OnSetVisible(e){if(this._autoAttach){const t=this._elementMap.get(e.elementId);t.style.display=e.isVisible?"":"none"}}_OnUpdatePosition(e){if(this._autoAttach){const t=this._elementMap.get(e.elementId);t.style.left=e.left+"px",t.style.top=e.top+"px",t.style.width=e.width+"px",t.style.height=e.height+"px";const n=e.fontSize;null!==n&&(t.style.fontSize=n+"em")}}_OnUpdateState(e){const t=this._elementMap.get(e.elementId);this.UpdateState(t,e)}UpdateState(){throw new Error("required override")}_OnSetFocus(e){const t=this._elementMap.get(e.elementId);e.focus?t.focus():t.blur()}_OnSetCssStyle(e){const t=this._elementMap.get(e.elementId);t.style[e.prop]=e.val}GetElementById(e){return this._elementMap.get(e)}},"use strict";{function t(e){if(e.isStringSrc){const t=document.createElement("script");t.async=!1,t.textContent=e.str,document.head.appendChild(t)}else return new Promise((t,n)=>{const a=document.createElement("script");a.onload=t,a.onerror=n,a.async=!1,a.src=e,document.head.appendChild(a)})}async function r(e){const t=await s(e),n=new TextDecoder("utf-8");return n.decode(t)}function s(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=e=>n(e),a.readAsArrayBuffer(e)})}function _(e){return n.has(e)}const a=/(iphone|ipod|ipad)/i.test(navigator.userAgent);let e=new Audio;const d={"audio/webm; codecs=opus":!!e.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!e.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!e.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!e.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!e.canPlayType("audio/mp4"),"audio/mpeg":!!e.canPlayType("audio/mpeg")};e=null;const p=[];let u=0;window.RealFile=window.File;const i=[],v=new Map,g=new Map;let l=0;const m=[];self.runOnStartup=function(e){if("function"!=typeof e)throw new Error("runOnStartup called without a function");m.push(e)},self.getGlobal=function(e){if(!e)throw new Error("missing global variable");return e};const n=new Set(["cordova","playable-ad","instant-games"]);window.RuntimeInterface=class e{constructor(e){this._useWorker=e.useWorker,this._messageChannelPort=null,this._baseUrl="",this._scriptFolder=e.scriptFolder,this._workerScriptBlobURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._exportType=e.exportType,_(this._exportType)&&this._useWorker&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in WebViews due to crbug.com/923007. Reverting to DOM mode."),this._useWorker=!1),this._transferablesBroken=!1,this._localFileBlobs=null,this._localFileStrings=null,("html5"===this._exportType||"playable-ad"===this._exportType)&&"file"===location.protocol.substr(0,4)&&alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)"),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",e=>this._OnCordovaFetchLocalFile(e)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",e=>this._OnCreateJobWorker(e)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(e)):this._Init(e)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetBaseURL(){return this._baseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsiOSCordova(){return a&&"cordova"===this._exportType}IsiOSWebView(){return a&&_(this._exportType)||navigator.standalone}async _Init(e){if("playable-ad"===this._exportType){this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs();for(let t=0,n=e.engineScripts.length;t<n;++t){const n=e.engineScripts[t].toLowerCase();this._localFileStrings.hasOwnProperty(n)?e.engineScripts[t]={isStringSrc:!0,str:this._localFileStrings[n]}:this._localFileBlobs.hasOwnProperty(n)&&(e.engineScripts[t]=URL.createObjectURL(this._localFileBlobs[n]))}}if(e.baseUrl)this._baseUrl=e.baseUrl;else{const e=location.origin;this._baseUrl=("null"===e?"file:///":e)+location.pathname;const t=this._baseUrl.lastIndexOf("/");-1!==t&&(this._baseUrl=this._baseUrl.substr(0,t+1))}if(e.workerScripts)for(const[t,n]of Object.entries(e.workerScripts))this._workerScriptBlobURLs[t]=URL.createObjectURL(n);const t=new MessageChannel;this._messageChannelPort=t.port1,this._messageChannelPort.onmessage=e=>this._OnMessageFromRuntime(e.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(e=>this._OnMessageFromDebugger(e)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),this.MaybeForceBodySize(),"object"==typeof window.StatusBar&&window.StatusBar.hide(),"object"==typeof window.AndroidFullScreen&&window.AndroidFullScreen.immersiveMode(),await this._TestTransferablesWork(),this._useWorker?await this._InitWorker(e,t.port2):await this._InitDOM(e,t.port2)}_GetWorkerURL(e){return this._workerScriptBlobURLs.hasOwnProperty(e)?this._workerScriptBlobURLs[e]:e.endsWith("/workermain.js")&&this._workerScriptBlobURLs.hasOwnProperty("workermain.js")?this._workerScriptBlobURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(e.toLowerCase())?URL.createObjectURL(this._localFileBlobs[e.toLowerCase()]):e}async CreateWorker(t,n,i){if(t.startsWith("blob:"))return new Worker(t,i);if(this.IsiOSCordova()){const e=await this.CordovaFetchLocalFileAsArrayBuffer(this._scriptFolder+t),n=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(n),i)}const r=new URL(t,n),a=location.origin!==r.origin;if(a){const e=await fetch(r);if(!e.ok)throw new Error("failed to fetch worker script");const t=await e.blob();return new Worker(URL.createObjectURL(t),i)}return new Worker(r,i)}MaybeForceBodySize(){if(this.IsiOSWebView()){const t=document.documentElement.style,n=document.body.style,a=window.innerWidth<window.innerHeight,i=a?window.screen.width:window.screen.height,r=a?window.screen.height:window.screen.width;n.height=t.height=r+"px",n.width=t.width=i+"px"}}_GetCommonRuntimeOptions(t){return{baseUrl:this._baseUrl,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,devicePixelRatio:window.devicePixelRatio,isFullscreen:e.IsDocumentFullscreen(),projectData:t.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,exportType:t.exportType,isDebug:-1<self.location.search.indexOf("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:d,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isFBInstantAvailable:"undefined"!=typeof self.FBInstant}}async _InitWorker(e,t){const n=this._GetWorkerURL(e.workerMainUrl);this._worker=await this.CreateWorker(n,this._baseUrl,{name:"Runtime"}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const a=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas),window.c3canvas=this._canvas,this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(e),{type:"init-runtime",isInWorker:!0,messagePort:t,canvas:a,workerDependencyScripts:e.workerDependencyScripts||[],engineScripts:e.engineScripts,projectScripts:window.cr_allProjectScripts,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[t,a,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=i.map(e=>new e(this)),this._FindRuntimeDOMHandler(),self.c3_callFunction=(e,t)=>this._runtimeDomHandler._InvokeFunctionFromJS(e,t),"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(n,a){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window.c3canvas=this._canvas,this._domHandlers=i.map(e=>new e(this)),this._FindRuntimeDOMHandler();const r=n.engineScripts.map(e=>"string"==typeof e?new URL(e,this._baseUrl).toString():e);if(Array.isArray(n.workerDependencyScripts)&&r.unshift(...n.workerDependencyScripts),await Promise.all(r.map(e=>t(e))),n.projectScripts&&0<n.projectScripts.length){const e=self.C3_ProjectScriptsStatus;try{if(await Promise.all(n.projectScripts.map(e=>t(e[1]))),Object.values(e).some(e=>!e))return void self.setTimeout(()=>this._ReportProjectScriptError(e),100)}catch(t){return console.error("[Preview] Error loading project scripts: ",t),void self.setTimeout(()=>this._ReportProjectScriptError(e),100)}}if("preview"===this._exportType&&"object"!=typeof self.C3.ScriptsInEvents)return console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),void alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.");const s=Object.assign(this._GetCommonRuntimeOptions(n),{isInWorker:!1,messagePort:a,canvas:this._canvas,runOnStartupFunctions:m});this._localRuntime=self.C3_CreateRuntime(s),await self.C3_InitRuntime(this._localRuntime,s)}_ReportProjectScriptError(e){const t=Object.entries(e).filter(e=>!e[1]).map(e=>e[0]),n=`Failed to load project script '${t[0]}'. Check all your JavaScript code has valid syntax.`;console.error("[Preview] "+n),alert(n)}async _OnCreateJobWorker(){const e=await this._jobScheduler._CreateJobWorker();return{outputPort:e,transferables:[e]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(t,n,a,i,r){this._messageChannelPort.postMessage({type:"event",component:t,handler:n,dispatchOpts:i||null,data:a,responseId:null},this._transferablesBroken?void 0:r)}PostToRuntimeComponentAsync(t,n,a,i,r){const e=l++,s=new Promise((t,n)=>{g.set(e,{resolve:t,reject:n})});return this._messageChannelPort.postMessage({type:"event",component:t,handler:n,dispatchOpts:i||null,data:a,responseId:e},this._transferablesBroken?void 0:r),s}["_OnMessageFromRuntime"](e){const t=e.type;if("event"===t)this._OnEventFromRuntime(e);else if("result"===t)this._OnResultFromRuntime(e);else if("runtime-ready"===t)this._OnRuntimeReady();else if("alert"===t)alert(e.message);else throw new Error(`unknown message '${t}'`)}_OnEventFromRuntime(t){const n=t.component,i=t.handler,a=t.data,r=t.responseId,e=v.get(n);if(!e)return void console.warn(`[DOM] No event handlers for component '${n}'`);const s=e.get(i);if(!s)return void console.warn(`[DOM] No handler '${i}' for component '${n}'`);let o=null;try{o=s(a)}catch(e){return console.error(`Exception in '${n}' handler '${i}':`,e),void(null!==r&&this._PostResultToRuntime(r,!1,""+e))}null!==r&&(o&&o.then?o.then(e=>this._PostResultToRuntime(r,!0,e)).catch(e=>{console.error(`Rejection from '${n}' handler '${i}':`,e),this._PostResultToRuntime(r,!1,""+e)}):this._PostResultToRuntime(r,!0,o))}_PostResultToRuntime(e,t,n){let a;n&&n.transferables&&(a=n.transferables),this._messageChannelPort.postMessage({type:"result",responseId:e,isOk:t,result:n},a)}_OnResultFromRuntime(t){const n=t.responseId,a=t.isOk,i=t.result,r=g.get(n);a?r.resolve(i):r.reject(i),g.delete(n)}AddRuntimeComponentMessageHandler(e,t,n){let a=v.get(e);if(a||(a=new Map,v.set(e,a)),a.has(t))throw new Error(`[DOM] Component '${e}' already has handler '${t}'`);a.set(t,n)}static AddDOMHandlerClass(e){if(i.includes(e))throw new Error("DOM handler already added");i.push(e)}_FindRuntimeDOMHandler(){for(const e of this._domHandlers)if("runtime"===e.GetComponentID())return void(this._runtimeDomHandler=e);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(e){this.PostToRuntimeComponent("debugger","message",e)}_OnRuntimeReady(){for(const e of this._domHandlers)e.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(e){this._rafCallbacks.push(e),this._RequestAnimationFrame()}_RemoveRAFCallback(e){const t=this._rafCallbacks.indexOf(e);if(-1===t)throw new Error("invalid callback");this._rafCallbacks.splice(t,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const e of this._rafCallbacks)e();this._RequestAnimationFrame()}TryPlayMedia(e){this._runtimeDomHandler.TryPlayMedia(e)}RemovePendingPlay(e){this._runtimeDomHandler.RemovePendingPlay(e)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(e){this._runtimeDomHandler.SetSilent(e)}IsAudioFormatSupported(e){return!!d[e]}async _WasmDecodeWebMOpus(e){const t=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:e},null,[e]);return new Float32Array(t)}IsAbsoluteURL(e){return /^(?:[a-z]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)}IsRelativeURL(e){return!this.IsAbsoluteURL(e)}async _OnCordovaFetchLocalFile(e){const t=e.filename;switch(e.as){case"text":return await this.CordovaFetchLocalFileAsText(t);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(t);default:throw new Error("unsupported type");}}_GetPermissionAPI(){const e=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if("object"!=typeof e)throw new Error("Permission API is not loaded");return e}_MapPermissionID(e,t){const n=e[t];if("string"!=typeof n)throw new Error("Invalid permission name");return n}_HasPermission(e){const t=this._GetPermissionAPI();return new Promise((n,a)=>t.checkPermission(this._MapPermissionID(t,e),e=>n(!!e.hasPermission),a))}_RequestPermission(e){const t=this._GetPermissionAPI();return new Promise((n,a)=>t.requestPermission(this._MapPermissionID(t,e),e=>n(!!e.hasPermission),a))}async RequestPermissions(e){if("cordova"!==this.GetExportType())return!0;if(this.IsiOSCordova())return!0;for(const t of e){const e=await this._HasPermission(t);if(e)continue;const n=await this._RequestPermission(t);if(!1===n)return!1}return!0}async RequirePermissions(...e){if(!1===(await this.RequestPermissions(e)))throw new Error("Permission not granted")}CordovaFetchLocalFile(e){const t=window.cordova.file.applicationDirectory+"www/"+e.toLowerCase();return new Promise((e,n)=>{window.resolveLocalFileSystemURL(t,t=>{t.file(e,n)},n)})}async CordovaFetchLocalFileAsText(e){const t=await this.CordovaFetchLocalFile(e);return await r(t)}_CordovaMaybeStartNextArrayBufferRead(){if(p.length&&!(8<=u)){u++;const e=p.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(e.filename,e.successCallback,e.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(e){return new Promise((t,n)=>{p.push({filename:e,successCallback:e=>{u--,this._CordovaMaybeStartNextArrayBufferRead(),t(e)},errorCallback:e=>{u--,this._CordovaMaybeStartNextArrayBufferRead(),n(e)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(t,n,e){try{const a=await this.CordovaFetchLocalFile(t),i=await s(a);n(i)}catch(t){e(t)}}async _ConvertDataUrisToBlobs(){const e=[];for(const[t,n]of Object.entries(this._localFileBlobs))e.push(this._ConvertDataUriToBlobs(t,n));await Promise.all(e)}async _ConvertDataUriToBlobs(e,t){if("object"==typeof t)this._localFileBlobs[e]=new Blob([t.str],{type:t.type}),this._localFileStrings[e]=t.str;else{let n=await this._FetchDataUri(t);n||(n=this._DataURIToBinaryBlobSync(t)),this._localFileBlobs[e]=n}}async _FetchDataUri(e){try{const t=await fetch(e);return await t.blob()}catch(e){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",e),null}}_DataURIToBinaryBlobSync(e){const t=this._ParseDataURI(e);return this._BinaryStringToBlob(t.data,t.mime_type)}_ParseDataURI(t){const n=t.indexOf(",");if(0>n)throw new URIError("expected comma in data: uri");const a=t.substring(5,n),r=t.substring(n+1),s=a.split(";"),e=s[0]||"",o=s[1],d=s[2];let l;return l="base64"===o||"base64"===d?atob(r):decodeURIComponent(r),{mime_type:e,data:l}}_BinaryStringToBlob(t,n){let a,i,r=t.length,e=r>>2,s=new Uint8Array(r),o=new Uint32Array(s.buffer,0,e);for(a=0,i=0;a<e;++a)o[a]=t.charCodeAt(i++)|t.charCodeAt(i++)<<8|t.charCodeAt(i++)<<16|t.charCodeAt(i++)<<24;for(let e=3&r;e--;)s[i]=t.charCodeAt(i),++i;return new Blob([s],{type:n})}_TestTransferablesWork(){let e=null;const t=new Promise(t=>e=t),n=new ArrayBuffer(1),i=new MessageChannel;return i.port2.onmessage=t=>{t.data&&t.data.arrayBuffer||(this._transferablesBroken=!0,console.warn("MessageChannel transfers determined to be broken. Disabling transferables.")),e()},i.port1.postMessage({arrayBuffer:n},[n]),t}}}{function t(e){return e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents||e.originalEvent&&e.originalEvent.sourceCapabilities&&e.originalEvent.sourceCapabilities.firesTouchEvents}function s(e){return new Promise((t,n)=>{const a=document.createElement("link");a.onload=()=>t(a),a.onerror=e=>n(e),a.rel="stylesheet",a.href=e,document.head.appendChild(a)})}function a(e){return new Promise((t,n)=>{const a=new Image;a.onload=()=>t(a),a.onerror=e=>n(e),a.src=e})}async function _(e){const t=URL.createObjectURL(e);try{return await a(t)}finally{URL.revokeObjectURL(t)}}function d(e){return new Promise((t,n)=>{let a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=e=>n(e),a.readAsText(e)})}async function u(e,t,n){if(!/firefox/i.test(navigator.userAgent))return await _(e);let r=await d(e);const s=new DOMParser,o=s.parseFromString(r,"image/svg+xml"),l=o.documentElement;if(l.hasAttribute("width")&&l.hasAttribute("height")){const t=l.getAttribute("width"),n=l.getAttribute("height");if(!t.includes("%")&&!n.includes("%"))return await _(e)}l.setAttribute("width",t+"px"),l.setAttribute("height",n+"px");const i=new XMLSerializer;return r=i.serializeToString(o),e=new Blob([r],{type:"image/svg+xml"}),await _(e)}function e(e){do{if(e.parentNode&&e.hasAttribute("contenteditable"))return!0;e=e.parentNode}while(e);return!1}function g(e){const t=e.target.tagName.toLowerCase();o.has(t)&&e.preventDefault()}function h(e){(e.metaKey||e.ctrlKey)&&e.preventDefault()}function i(){try{return window.parent&&window.parent.document.hasFocus()}catch(e){return!1}}function c(){const t=document.activeElement;if(!t)return!1;const n=t.tagName.toLowerCase(),a=new Set(["email","number","password","search","tel","text","url"]);return"textarea"===n||("input"===n?a.has(t.type.toLowerCase()||"text"):e(t))}const v=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),l={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},m={dispatchUserScriptEvent:!0},n={dispatchRuntimeEvent:!0},o=new Set(["canvas","body","html"]);self.C3_GetSvgImageSize=async function(e){const t=await _(e);if(0<t.width&&0<t.height)return[t.width,t.height];else{t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",document.body.appendChild(t);const e=t.getBoundingClientRect();return document.body.removeChild(t),[e.width,e.height]}},self.C3_RasterSvgImageBlob=async function(t,n,a,r,s){const e=await u(t,n,a),o=document.createElement("canvas");o.width=r,o.height=s;const d=o.getContext("2d");return d.drawImage(e,0,0,n,a),o};let p=!1;document.addEventListener("pause",()=>p=!0),document.addEventListener("resume",()=>p=!1);const b=class extends DOMHandler{constructor(t){super(t,"runtime"),this._isFirstSizeUpdate=!0,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._debugHighlightElem=null,this._pointerRawUpdateRateLimiter=null,this._lastPointerRawUpdateEvent=null,t.AddRuntimeComponentMessageHandler("canvas","update-size",e=>this._OnUpdateCanvasSize(e)),t.AddRuntimeComponentMessageHandler("runtime","invoke-download",e=>this._OnInvokeDownload(e)),t.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",e=>this._OnRasterSvgImage(e)),t.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",e=>this._OnGetSvgImageSize(e)),t.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",e=>this._OnSetTargetOrientation(e)),t.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),t.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",e=>this._OnPostToDebugger(e)),t.AddRuntimeComponentMessageHandler("runtime","go-to-script",e=>this._OnPostToDebugger(e)),t.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),t.AddRuntimeComponentMessageHandler("runtime","debug-highlight",e=>this._OnDebugHighlight(e)),t.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),t.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),t.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",e=>this._OnAddStylesheet(e)),t.AddRuntimeComponentMessageHandler("runtime","alert",e=>this._OnAlert(e));const n=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",t=>{const a=t.target,i=a.tagName.toLowerCase();n.has(i)||e(a)||t.preventDefault()});const a=t.GetCanvas();window.addEventListener("selectstart",g),window.addEventListener("gesturehold",g),a.addEventListener("selectstart",g),a.addEventListener("gesturehold",g),window.addEventListener("touchstart",g,{passive:!1}),"undefined"==typeof PointerEvent?a.addEventListener("touchstart",g):(window.addEventListener("pointerdown",g,{passive:!1}),a.addEventListener("pointerdown",g)),this._mousePointerLastButtons=0,window.addEventListener("mousedown",e=>{1===e.button&&e.preventDefault()}),window.addEventListener("mousewheel",h,{passive:!1}),window.addEventListener("wheel",h,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),t.IsiOSWebView()&&window.addEventListener("focusout",()=>{c()||(document.scrollingElement.scrollTop=0)}),this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden)),{isSuspended:!!(document.hidden||p)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:i()}),this._mousePointerLastButtons=0}),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("webkitfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("mozfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("keydown",e=>this._OnKeyEvent("keydown",e)),window.addEventListener("keyup",e=>this._OnKeyEvent("keyup",e)),window.addEventListener("dblclick",e=>this._OnMouseEvent("dblclick",e,l)),window.addEventListener("wheel",e=>this._OnMouseWheelEvent("wheel",e)),"undefined"==typeof PointerEvent?(window.addEventListener("mousedown",e=>{this._HandlePointerDownFocus(e),this._OnMouseEventAsPointer("pointerdown",e)}),window.addEventListener("mousemove",e=>this._OnMouseEventAsPointer("pointermove",e)),window.addEventListener("mouseup",e=>this._OnMouseEventAsPointer("pointerup",e)),window.addEventListener("touchstart",e=>{this._HandlePointerDownFocus(e),this._OnTouchEvent("pointerdown",e)}),window.addEventListener("touchmove",e=>this._OnTouchEvent("pointermove",e)),window.addEventListener("touchend",e=>this._OnTouchEvent("pointerup",e)),window.addEventListener("touchcancel",e=>this._OnTouchEvent("pointercancel",e))):(window.addEventListener("pointerdown",e=>{this._HandlePointerDownFocus(e),this._OnPointerEvent("pointerdown",e)}),this._iRuntime.UsesWorker()&&"undefined"!=typeof window.onpointerrawupdate&&self===self.top?(this._pointerRawUpdateRateLimiter=new RateLimiter(()=>this._DoSendPointerRawUpdate(),5),this._pointerRawUpdateRateLimiter.SetCanRunImmediate(!0),window.addEventListener("pointerrawupdate",e=>this._OnPointerRawUpdate(e))):window.addEventListener("pointermove",e=>this._OnPointerEvent("pointermove",e)),window.addEventListener("pointerup",e=>this._OnPointerEvent("pointerup",e)),window.addEventListener("pointercancel",e=>this._OnPointerEvent("pointercancel",e)));const e=()=>this._PlayPendingMedia();window.addEventListener("pointerup",e,!0),window.addEventListener("touchend",e,!0),window.addEventListener("click",e,!0),window.addEventListener("keydown",e,!0),window.addEventListener("gamepadconnected",e,!0)}_PostRuntimeEvent(e,t){this.PostToRuntime(e,t||null,n)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_OnWindowResize(){const e=this._GetWindowInnerWidth(),t=this._GetWindowInnerHeight();this._PostRuntimeEvent("window-resize",{innerWidth:e,innerHeight:t,devicePixelRatio:window.devicePixelRatio}),this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(e,t,0))}_ScheduleSimulatedResize(e,t,n){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(e,t,n),48)}_OnSimulatedResize(t,n,a){const i=this._GetWindowInnerWidth(),r=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,i!=t||r!=n?this._PostRuntimeEvent("window-resize",{innerWidth:i,innerHeight:r,devicePixelRatio:window.devicePixelRatio}):10>a&&this._ScheduleSimulatedResize(i,r,a+1)}_OnSetTargetOrientation(e){this._targetOrientation=e.targetOrientation}_TrySetTargetOrientation(){const e=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(e).catch(e=>console.warn("[Construct 3] Failed to lock orientation: ",e));else try{let t=!1;screen.lockOrientation?t=screen.lockOrientation(e):screen.webkitLockOrientation?t=screen.webkitLockOrientation(e):screen.mozLockOrientation?t=screen.mozLockOrientation(e):screen.msLockOrientation&&(t=screen.msLockOrientation(e)),t||console.warn("[Construct 3] Failed to lock orientation")}catch(e){console.warn("[Construct 3] Failed to lock orientation: ",e)}}_OnFullscreenChange(){const e=RuntimeInterface.IsDocumentFullscreen();e&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:e,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(e){console.warn("[Construct 3] Fullscreen request failed: ",e),this.PostToRuntime("fullscreenerror",{isFullscreen:RuntimeInterface.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(e){e?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:e})}_OnKeyEvent(e,t){"Backspace"===t.key&&g(t);const n=v.get(t.code)||t.code;this._PostToRuntimeMaybeSync(e,{code:n,key:t.key,which:t.which,repeat:t.repeat,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp},l)}_OnMouseWheelEvent(e,t){this.PostToRuntime(e,{clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timeStamp:t.timeStamp},l)}_OnMouseEvent(e,n,a){t(n)||this._PostToRuntimeMaybeSync(e,{button:n.button,buttons:n.buttons,clientX:n.clientX,clientY:n.clientY,pageX:n.pageX,pageY:n.pageY,timeStamp:n.timeStamp},a)}_OnMouseEventAsPointer(e,n){if(!t(n)){const t=this._mousePointerLastButtons;"pointerdown"===e&&0!==t?e="pointermove":"pointerup"==e&&0!==n.buttons&&(e="pointermove"),this._PostToRuntimeMaybeSync(e,{pointerId:1,pointerType:"mouse",button:n.button,buttons:n.buttons,lastButtons:t,clientX:n.clientX,clientY:n.clientY,pageX:n.pageX,pageY:n.pageY,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:n.timeStamp},l),this._mousePointerLastButtons=n.buttons,this._OnMouseEvent(n.type,n,m)}}_OnPointerEvent(e,t){this._pointerRawUpdateRateLimiter&&"pointermove"!==e&&this._pointerRawUpdateRateLimiter.Reset();let n=0;if("mouse"===t.pointerType&&(n=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(e,{pointerId:t.pointerId,pointerType:t.pointerType,button:t.button,buttons:t.buttons,lastButtons:n,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,width:t.width||0,height:t.height||0,pressure:t.pressure||0,tangentialPressure:t.tangentialPressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,twist:t.twist||0,timeStamp:t.timeStamp},l),"mouse"===t.pointerType){let n="mousemove";"pointerdown"===e?n="mousedown":"pointerup"==e&&(n="pointerup"),this._OnMouseEvent(n,t,m),this._mousePointerLastButtons=t.buttons}}_OnPointerRawUpdate(e){this._lastPointerRawUpdateEvent=e,this._pointerRawUpdateRateLimiter.Call()}_DoSendPointerRawUpdate(){this._OnPointerEvent("pointermove",this._lastPointerRawUpdateEvent),this._lastPointerRawUpdateEvent=null}_OnTouchEvent(e,t){for(let n=0,a=t.changedTouches.length;n<a;++n){const a=t.changedTouches[n];this._PostToRuntimeMaybeSync(e,{pointerId:a.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,width:2*(a.radiusX||a.webkitRadiusX||0),height:2*(a.radiusY||a.webkitRadiusY||0),pressure:a.force||a.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:a.rotationAngle||0,timeStamp:t.timeStamp},l)}}_HandlePointerDownFocus(e){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(e.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(e){return!e||e===document||e===window||e===document.body||"canvas"===e.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",e=>this._OnDeviceOrientation(e)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",e=>this._OnDeviceMotion(e)))}_OnDeviceOrientation(e){this.PostToRuntime("deviceorientation",{alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0,timeStamp:e.timeStamp},l)}_OnDeviceMotion(t){let n=null;const a=t.acceleration;a&&(n={x:a.x||0,y:a.y||0,z:a.z||0});let i=null;const r=t.accelerationIncludingGravity;r&&(i={x:r.x||0,y:r.y||0,z:r.z||0});let e=null;const s=t.rotationRate;s&&(e={alpha:s.alpha||0,beta:s.beta||0,gamma:s.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:n,accelerationIncludingGravity:i,rotationRate:e,interval:t.interval,timeStamp:t.timeStamp},l)}_OnUpdateCanvasSize(e){const t=this.GetRuntimeInterface(),n=t.GetCanvas();n.style.width=e.styleWidth+"px",n.style.height=e.styleHeight+"px",n.style.marginLeft=e.marginLeft+"px",n.style.marginTop=e.marginTop+"px",t.MaybeForceBodySize(),this._isFirstSizeUpdate&&(n.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(t){const n=t.url,i=t.filename,r=document.createElement("a"),e=document.body;r.textContent=i,r.href=n,r.download=i,e.appendChild(r),r.click(),e.removeChild(r)}async _OnRasterSvgImage(t){const n=t.blob,a=t.imageWidth,r=t.imageHeight,s=t.surfaceWidth,e=t.surfaceHeight,o=t.imageBitmapOpts,d=await self.C3_RasterSvgImageBlob(n,a,r,s,e);let l;return l=o?await createImageBitmap(d,o):await createImageBitmap(d),{imageBitmap:l,transferables:[l]}}async _OnGetSvgImageSize(e){return await self.C3_GetSvgImageSize(e.blob)}async _OnAddStylesheet(e){await s(e.url)}_PlayPendingMedia(){const e=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const t of e){const e=t.play();e&&e.catch(()=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}}TryPlayMedia(e){if("function"!=typeof e.play)throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(e);let t;try{t=e.play()}catch(t){return void this._mediaPendingPlay.add(e)}t&&t.catch(()=>{this._mediaRemovedPendingPlay.has(e)||this._mediaPendingPlay.add(e)})}RemovePendingPlay(e){this._mediaPendingPlay.delete(e),this._mediaRemovedPendingPlay.add(e)}SetSilent(e){this._isSilent=!!e}_OnDebugHighlight(e){const t=e.show;if(!t)return void(this._debugHighlightElem&&(this._debugHighlightElem.style.display="none"));this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const n=this._debugHighlightElem;n.style.display="",n.style.left=e.left-1+"px",n.style.top=e.top-1+"px",n.style.width=e.width+2+"px",n.style.height=e.height+2+"px",n.textContent=e.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(e){window.c3_postToMessagePort&&(e.from="runtime",window.c3_postToMessagePort(e))}_InvokeFunctionFromJS(e,t){return this.PostToRuntimeAsync("js-invoke-function",{name:e,params:t})}_OnAlert(e){alert(e.message)}};RuntimeInterface.AddDOMHandlerClass(b)}{const e=document.currentScript.src;self.JobSchedulerDOM=class{constructor(t){this._runtimeInterface=t,this._baseUrl=e?e.substr(0,e.lastIndexOf("/")+1):t.GetBaseURL(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface._GetWorkerURL("dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"DispatchWorker"});const t=new MessageChannel;this._inputPort=t.port1,this._dispatchWorker.postMessage({type:"_init","in-port":t.port2},[t.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const t=this._jobWorkers.length,n=this._runtimeInterface._GetWorkerURL("jobworker.js"),a=await this._runtimeInterface.CreateWorker(n,this._baseUrl,{name:"JobWorker"+t}),i=new MessageChannel,r=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:i.port1},[i.port1]),a.postMessage({type:"init",number:t,"dispatch-port":i.port2,"output-port":r.port2},[i.port2,r.port2]),this._jobWorkers.push(a),r.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}if("use strict",window.C3_IsSupported){const e="undefined"!=typeof OffscreenCanvas;window.c3_runtimeInterface=new RuntimeInterface({useWorker:e,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"})}{function t(e){e.stopPropagation()}function n(e){13!==e.which&&27!==e.which&&e.stopPropagation()}const e=class extends DOMElementHandler{constructor(e){super(e,"text-input"),this.AddDOMElementMessageHandler("scroll-to-bottom",e=>this._OnScrollToBottom(e))}CreateElement(i,a){let r;const s=a.type;return"textarea"===s?(r=document.createElement("textarea"),r.style.resize="none"):(r=document.createElement("input"),r.type=s),r.style.position="absolute",r.autocomplete="off",r.addEventListener("touchstart",t),r.addEventListener("touchmove",t),r.addEventListener("touchend",t),r.addEventListener("mousedown",t),r.addEventListener("mouseup",t),r.addEventListener("keydown",n),r.addEventListener("keyup",n),r.addEventListener("click",e=>{e.stopPropagation(),this._PostToRuntimeElementMaybeSync("click",i)}),r.addEventListener("dblclick",e=>{e.stopPropagation(),this._PostToRuntimeElementMaybeSync("dblclick",i)}),r.addEventListener("input",()=>this.PostToRuntimeElement("change",i,{text:r.value})),r.id=a.id,this.UpdateState(r,a),r}UpdateState(e,t){e.value=t.text,e.placeholder=t.placeholder,e.title=t.title,e.disabled=!t.isEnabled,e.readOnly=t.isReadOnly,e.spellcheck=t.spellCheck}_OnScrollToBottom(e){e.scrollTop=e.scrollHeight}};RuntimeInterface.AddDOMHandlerClass(e)}{function t(e){e.stopPropagation()}const e=class extends DOMElementHandler{constructor(e){super(e,"button")}CreateElement(n,a){const i=document.createElement("input"),r=a.isCheckbox;let e=i;if(r){i.type="checkbox";const t=document.createElement("label");t.appendChild(i),t.appendChild(document.createTextNode("")),t.style.fontFamily="sans-serif",t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.display="inline-block",t.style.color="black",e=t}else i.type="button";return e.style.position="absolute",e.addEventListener("touchstart",t),e.addEventListener("touchmove",t),e.addEventListener("touchend",t),e.addEventListener("mousedown",t),e.addEventListener("mouseup",t),e.addEventListener("keydown",t),e.addEventListener("keyup",t),i.addEventListener("click",()=>this._PostToRuntimeElementMaybeSync("click",n,{isChecked:i.checked})),i.id=a.id,this.UpdateState(e,a),e}_GetInputElem(e){return"input"===e.tagName.toLowerCase()?e:e.firstChild}UpdateState(e,t){const n=this._GetInputElem(e);n.checked=t.isChecked,n.disabled=!t.isEnabled,e.title=t.title,e===n?n.value=t.text:e.lastChild.textContent=t.text}};RuntimeInterface.AddDOMHandlerClass(e)}{function t(e){e.stopPropagation()}const e=class extends DOMElementHandler{constructor(e){super(e,"list"),this.AddDOMElementMessageHandler("set-selected-index",(e,t)=>this._OnSetSelectedIndex(e,t.selectedIndex)),this.AddDOMElementMessageHandler("add-item",(e,t)=>this._OnAddItem(e,t)),this.AddDOMElementMessageHandler("remove-item",(e,t)=>this._OnRemoveItem(e,t)),this.AddDOMElementMessageHandler("set-item",(e,t)=>this._OnSetItem(e,t)),this.AddDOMElementMessageHandler("clear",e=>this._OnClear(e)),this.AddDOMElementMessageHandler("load-state",(e,t)=>this._OnLoadState(e,t))}CreateElement(n,a){const i=a.isDropdown,r=a.isMultiSelect,e=a.items,s=document.createElement("select");s.style.position="absolute",s.style.userSelect="none",s.style.webkitUserSelect="none",s.multiple=r,i||(s.size=2);for(const t of e)s.add(this._CreateOption(t));return s.addEventListener("touchstart",t),s.addEventListener("touchmove",t),s.addEventListener("touchend",t),s.addEventListener("mousedown",t),s.addEventListener("mouseup",t),s.addEventListener("click",e=>{e.stopPropagation(),this._PostToRuntimeElementMaybeSync("click",n,this._GetSelectionState(s))}),s.addEventListener("dblclick",e=>{e.stopPropagation(),this._PostToRuntimeElementMaybeSync("dblclick",n,this._GetSelectionState(s))}),s.addEventListener("change",()=>this.PostToRuntimeElement("change",n,this._GetSelectionState(s))),s.id=a.id,this.UpdateState(s,a),s}_CreateOption(e){const t=document.createElement("option");return t.text=e,t}_GetSelectionState(e){const t=e.selectedIndex,n=[];for(let t=0,a=e.length;t<a;++t)e.options[t].selected&&n.push(t);return{selectedIndex:t,selectedIndices:n}}UpdateState(e,t){e.title=t.title,e.disabled=!t.isEnabled,e.multiple=!!t.isMultiSelect}_OnSetSelectedIndex(e,t){e.selectedIndex=t}_OnAddItem(t,n){const a=n.text,i=n.index,r=this._CreateOption(a);0>i?t.add(r):t.add(r,i)}_OnRemoveItem(e,t){e.remove(t.index)}_OnSetItem(e,t){e.options[t.index].text=t.text}_OnClear(e){e.innerHTML=""}_OnLoadState(e,t){e.innerHTML="";for(const n of t.items)e.add(this._CreateOption(n));e.selectedIndex=t.selectedIndex;for(const n of t.selectedIndices){const t=e.options[n];t&&(t.selected=!0)}}};RuntimeInterface.AddDOMHandlerClass(e)}{function t(e){return e%=c,0>e&&(e+=c),e}function n(e,t,n){return e<t?t:e>n?n:e}function r(e,t,n){return e+n*(t-e)}function s(e,t,n){return e===t?0:(n-e)/(t-e)}function o(t,n){var a=Math.cos,r=Math.sin;if(t===n)return 0;const s=r(t),e=a(t),o=r(n),d=a(n),l=s*o+e*d;return 1<=l?0:-1>=l?Math.PI:Math.acos(l)}function e(t,n){var a=Math.cos,i=Math.sin;const r=i(t),e=a(t),s=i(n),o=a(n);return 0>=e*s-r*o}function _(n,i,a){const r=o(n,i);return e(i,n)?t(n+r*a):t(n-r*a)}const d=[],c=2*Math.PI;class m{constructor(t,n,a,i,r,e){this._index=t,this._interp=n,this._precision=a,this._tag=i,this._userData=r,this._clientValueTag=e}GetRuntimeData(){return{tag:this._tag,interp:this._interp,userData:this._userData,cvt:this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!=typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(e){switch(this._precision){case 0:return e;case 1:return Math.fround(e);case 2:return 2===this._interp&&(e=t(e),e/=Math.PI,e-=1,e*=32767),n(0|e,-32768,32767);case 3:return 2===this._interp&&(e=t(e),e/=c,e*=255),n(0|e,0,255);default:return e;}}Write(e,t,n){switch(this._precision){case 0:e.setFloat64(t,n),t+=8;break;case 1:e.setFloat32(t,n),t+=4;break;case 2:e.setInt16(t,n),t+=2;break;case 3:e.setUint8(t,n),t+=1;break;default:e.setFloat32(t,n),t+=4;}return t}MaybeUnpack(e){return 2===this._interp?2===this._precision?(e/=32767,e+=1,e*=Math.PI,e):3===this._precision?(e/=255,e*=c,e):e:e}static InterpNetValue(t,n,a,i,e){return 0===t?e?a:n:1===t?r(n,a,i):2===t?_(n,a,i):e?a:n}}class i{constructor(e,t){this.timestamp=e,this.data=t}}class p{constructor(e,t,n){this._ro=e,this._domHandler=e.GetDOMHandler(),this._id=t,this._nid=n,this._data=[],this._data.length=this._ro.GetNetValues().length,this._lastChanged=0,this._lastTransmitted=0,this._transmitMe=!1,this._isAlive=!1,this._updates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null}GetRuntimeData(){const e=[];for(let t=0,n=this._ro.GetNetValues().length;t<n;++t)e.push(this.GetInterp(this._ro.GetSimTime(),t));const t={id:this._id,nid:this._nid,isTimedOut:this.IsTimedOut(),interpValues:e,latestUpdate:null},n=this.GetLatestUpdate();return n&&(t.latestUpdate={timestamp:n.timestamp,data:n.data}),t}GetId(){return this._id}GetNid(){return this._nid}SetAlive(e){this._isAlive=!!e}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(t,n){const i=t.netValues,r=this._ro.GetNetValues(),a=r.length;this._transmitMe=!1;for(let s=0;s<a;++s){const t=r[s],a=t.Clamp(i[s]);this._data[s]!==a&&(this._data[s]=a,this._lastChanged=n,this._ro.SetLastChanged(n))}const e=n-this._lastChanged,s=n-this._lastTransmitted,o=this._ro.GetBandwidth();this._transmitMe=!!(100>e&&0===o)||(1e3>e&&1>=o?95<=s:495<=s),this._transmitMe&&this._ro.IncNumberToTransmit()}WriteData(t,n,e){const a=this._ro.GetNetValues();this._lastTransmitted=e,t.setUint16(n,this._nid),n+=2;for(let i=0,r=this._data.length;i<r;++i)n=a[i].Write(t,n,this._data[i]);return n}AddUpdate(e,t){for(let n=0,a=this._updates.length;n<a;++n){const a=this._updates[n];if(a.timestamp===e)return;if(a.timestamp>e)return void this._updates.splice(n,0,new i(e,t))}this._updates.push(new i(e,t))}IsTimedOut(){return 0!==this._updates.length&&this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3e3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const e=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>e&&this._priorUpdate&&this._priorUpdate.timestamp<e)){this._nextUpdate=null;for(let t=0,n=this._updates.length;t<n;++t){const n=this._updates[t];if(n.timestamp<=e)(!this._priorUpdate||n.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=n);else{this._nextUpdate=n;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(t,n,a){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[n];const r=this._ro.GetNetValues();let e,o,d,l,_;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2&&!a){e=this._priorUpdate2.timestamp,o=this._priorUpdate2.data[n],d=this._priorUpdate.timestamp,l=this._priorUpdate.data[n];let a=t;return a>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(a=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),_=s(e,d,a),m.InterpNetValue(r[n].GetInterp(),o,l,_,!0)}return this._priorUpdate.data[n]}return e=this._priorUpdate.timestamp,o=this._priorUpdate.data[n],d=this._nextUpdate.timestamp,l=this._nextUpdate.data[n],_=s(e,d,t),m.InterpNetValue(r[n].GetInterp(),o,l,_,!1)}}self.C3NetValue=m,self.C3NetUpdate=i,self.C3RegisteredObject=class{constructor(e,t,n,a){switch(this._domHandler=e,this._roId=t,this._sid=n,this._nid=this._domHandler.GetNextObjectNid(),this._bandwidth=a,this._userData={},this._instanceByteSize=0,this._extrapolateLimit=250,this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500;}this._netValues=[],this._netInstances=[],this._idToNetInst=new Map,this._usedNids=new Set,this._nextNid=0,this._lastChanged=0,this._lastTransmitted=0,this._numberToTransmit=0,this._hasOverriddenNids=!1,this._deadNids=[],this._overrideNids=new Map,this._nidToNetInst=new Map,this._simTime=0,this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(e){this._nid=e}GetNid(){return this._nid}SetLastChanged(e){this._lastChanged=e}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(e){this._hasOverriddenNids=!!e}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(t,n,a,i,r){const e=new m(this._netValues.length,t,n,a,i,r);0===n?this._instanceByteSize+=8:1===n?this._instanceByteSize+=4:2===n?this._instanceByteSize+=2:3===n?this._instanceByteSize+=1:void 0,this._netValues.push(e)}AddUpdate(e,t,n){const a=this.GetNetInstForNid(t);a.AddUpdate(e,n)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const e of this._netInstances)e.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(e){return e=Math.floor(e),0>e||e>=this._netInstances.length?null:this._netInstances[e]}GetNetInstByNid(e){for(const t of this._netInstances)if(t.GetNid()===e)return t;return null}GetNetValuesJson(){const e=[];for(const t of this._netValues){const n={tag:t.GetTag(),precision:t.GetPrecision(),interp:t.GetInterp(),clientvaluetag:t.GetClientValueTag()};t.HasUserData()&&(n.userdata=t.GetUserData()),e.push(n)}return e}SetNetValuesFrom(e){this._netValues.length=0,this._instanceByteSize=0;for(const t of e)this.AddValue(t.interp,t.precision,t.tag,t.userdata,t.clientvaluetag)}GetNetInstForNid(e){let t=this._nidToNetInst.get(e);return t?t:(t=new p(this,-1,e),this._nidToNetInst.set(e,t),this._netInstances.push(t),t)}GetNetInstForId(e){let t=this._idToNetInst.get(e);return t?t:(t=new p(this,e,this.AllocateInstanceNid()),this._idToNetInst.set(e,t),this._netInstances.push(t),t)}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const e=this._nextNid;return this._usedNids.add(e),e}RemoveNetInstance(e){const t=e.GetId(),n=e.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(n),this._idToNetInst.delete(t),this._nidToNetInst.delete(n),this._usedNids.delete(n);const a=this._netInstances.indexOf(e);-1<a&&this._netInstances.splice(a,1)}UpdateData(t,n){this._numberToTransmit=0;for(const e of this._netInstances)e.SetAlive(!1);for(let a=0,e=t.length;a<e;++a){const i=t[a],e=i.uid,r=this.GetNetInstForId(e);r.SetAlive(!0),r.UpdateData(i,n)}for(const e of this._netInstances)e.IsAlive()||d.push(e);for(const e of d)this.RemoveNetInstance(e);d.length=0}WriteData(e,t,n){e.setUint16(t,this._nid),t+=2;let a=0;this._hasOverriddenNids&&(a=1),e.setUint8(t,a),t+=1,e.setUint16(t,this._numberToTransmit),t+=2,e.setUint16(t,this._instanceByteSize),t+=2;for(const a of this._netInstances)a.ShouldTransmit()&&(t=a.WriteData(e,t,n));return t}OverrideNid(e,t){if(this._idToNetInst.has(e))return void console.warn("OverrideNid passed id "+e+" which is already in use and cannot be overridden");if(this._usedNids.has(t))return void console.warn("OverrideNid passed nid "+t+" which is already in use and cannot be overridden");const n=new p(this,e,t);return this._idToNetInst.set(e,n),this._usedNids.add(t),this._netInstances.push(n),this._hasOverriddenNids=!0,n}RemoveObjectId(e){const t=this._idToNetInst.get(e);t&&this.RemoveNetInstance(t)}RemoveObjectNid(e){const t=this._nidToNetInst.get(e);t&&this.RemoveNetInstance(t)}GetRuntimeData(){return{hasOverriddenNids:this.HasOverriddenNids(),netValues:this._netValues.map(e=>e.GetRuntimeData()),netInstances:this._netInstances.map(e=>e.GetRuntimeData())}}GetRuntimeInfoRequest(){return{roId:this._roId,sid:this._sid,netValues:this._netValues.map(e=>e.GetRuntimeData())}}}}{function t(e){if(e)try{e.close()}catch(e){}}function n(e,t,n){return e===t?0:(n-e)/(t-e)}const i=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,r=[];class s{constructor(e,t,n){this._domHandler=e,this._id=t,this._nid=0,this._alias=n,this._pc=null,this._dco=null,this._isOOpen=!1,this._dcr=null,this._isROpen=!1,this._dcu=null,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._wasRemoved=!1,this._hasConfirmed=!1,this._lastHeardFrom=0,this._connectTime=0,this._errorCount=0,this._localClientState=[],this._lastStateChange=0,this._lastStateTransmit=0,this._clientStateUpdates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null,this._lastPingSent=0,this._awaitingPong=!1,this._lastSentPingId=1,this._lastPingTimes=[],this._latency=0,this._pdv=0,this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(e){this._nid=e}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(e){this._lastStateChange=e}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(e){this._lastStateTransmit=e}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(e,t){e.binaryType="arraybuffer",e.onopen=()=>{"o"===t?this._isOOpen=!0:"r"===t?this._isROpen=!0:"u"==t&&(this._isUOpen=!0),this._MaybeFireOpen()},e.onmessage=e=>{this._OnMessage(t,e)},e.onerror=e=>{console.error("Peer '"+this._id+"' datachannel '"+t+"' error: ",e),this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")},e.onclose=()=>{this.Remove("disconnect")}}Connect(){if(this.IsSelf())return;const e=this._domHandler.IsHost();this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._connectTime=performance.now(),this._pc=new i({iceServers:this._domHandler.GetICEServerList()}),this._pc.onicecandidate=e=>{e.candidate&&this._domHandler.SignallingSend({message:"icecandidate",toclientid:this._id,icecandidate:e.candidate})},this._pc.onsignalingstatechange=()=>{this._pc&&("closed"!==this._pc.signalingState||this.Remove("disconnect"))},this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))},this._pc.onconnectionstatechange=()=>{if(this._pc){const e=this._pc.connectionState;("failed"===e||"closed"===e)&&this.Remove("disconnect")}};const t=`c2mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;e?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:t}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:t}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:t}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(e=>{this._pc.setLocalDescription(e),this._domHandler.SignallingSend({message:"offer",toclientid:this._id,offer:e})}).catch(e=>{console.error("Host error creating offer for peer '"+this._id+"': ",e),this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=e=>{if(e.channel.protocol!==t)return console.error("Unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+expect_protocol+"'"),void this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+expect_protocol+"'");const n=e.channel.label;"o"===n?this._dco=e.channel:"r"===n?this._dcr=e.channel:"u"===n?this._dcu=e.channel:(console.error("Unknown datachannel label: "+e.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+e.channel.label+"'")),this._AttachDataChannelHandlers(e.channel,n)}}async _AddICECandidate(e){if(this._pc)try{await this._pc.addIceCandidate(e)}catch(e){console.warn("[Multiplayer] Error adding ICE candidate: ",e)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){this._firedOpen||this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){if(this._lastHeardFrom=performance.now(),this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({c:"j",i:this._id,n:this._nid,a:this._alias}),this),this.Send("o",JSON.stringify({c:"hi",hn:this._domHandler.GetHostPeer().GetNid(),n:this._nid,d:this._domHandler.GetClientDelay(),u:this._domHandler.GetPeerUpdateRateSec(),objs:this._domHandler.GetRegisteredObjectsMap(),cvs:this._domHandler.GetClientValuesJson()}));for(const e of this._domHandler.peers())!e.IsHost()&&e!==this&&e.IsOpen()&&this.Send("o",JSON.stringify({c:"j",i:e.GetId(),n:e.GetNid(),a:e.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0);this._domHandler._OnPeerOpen(this)}_MaybeFireClose(e){this._firedClose||!this._firedOpen||(this._OnClose(e),this._firedClose=!0,this._firedOpen=!1)}_OnClose(e){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({c:"l",i:this._id,a:this._alias,r:e}),this),this.IsSelf()||this._domHandler._OnPeerClose(this,e)}IsOpen(){return this._firedOpen&&!this._firedClose}Send(t,n){this._domHandler.StatIncOutboundCount();let a=0;n.length?a=n.length:n.byteLength&&(a=n.byteLength),this._domHandler.StatAddOutboundBandwidthCount(a);const i=this._domHandler.GetSimulatedPacketLoss(),r=this._domHandler.GetSimulatedLatency(),e=this._domHandler.GetSimulatedPdv();if(!(0<i&&"u"===t&&Math.random()<i))if(0===r&&0===e)this._DoSend(t,n);else{let a=1;"u"!==t&&Math.random()<i&&(a=3),setTimeout(()=>this._DoSend(t,n),r*a+Math.random()*e*a)}}_DoSend(e,t){try{"o"===e?this._isOOpen&&this._dco&&this._dco.send(t):"r"===e?this._isROpen&&this._dcr&&this._dcr.send(t):"u"==e&&this._isUOpen&&this._dcu&&this._dcu.send(t)}catch(n){if(this._wasRemoved)return;this._domHandler.IsHost()?"o"===e||"r"===e?("string"==typeof t?(console.error("Error sending "+t.length+"-char string on '"+e+"' to '"+this._alias+"', host kicking: ",n),console.log("String that failed to send from previous error was: "+t)):console.error("Error sending "+(t.length||t.byteLength)+"-byte binary on '"+e+"' to '"+this._alias+"', host kicking: ",n),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"==typeof t?(console.error("Too many errors ("+this._errorCount+") sending data on '"+e+"' to '"+this._alias+"', kicking; last error was for sending "+t.length+"-char string: ",n),console.log("String that failed to send from previous error was: "+t)):console.error("Too many errors ("+this._errorCount+") sending data on '"+e+"' to '"+this._alias+"', kicking; last error was for sending "+(t.length||t.byteLength)+"-byte binary: ",n),this.Remove("network error"))):console.error("Error sending data on '"+e+"': ",n)}}SendPing(e,t){return this._wasRemoved?void 0:!t&&!this.IsOpen()&&this._pc&&25e3<e-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),void this.Remove("timeout")):!t&&this.IsOpen()&&2e4<e-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),void this.Remove("timeout")):void(this._lastPingSent=e,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId))}SendPong(e){let t="pong:"+e.substr(5);this._domHandler.IsHost()&&(t+="/",t+=Math.round(performance.now()).toString()),this.Send("u",t)}_OnPong(t){if(!this._awaitingPong)return;const n=t.indexOf(":");if(-1<n){const e=parseFloat(t.substr(n+1));if(e!==this._lastSentPingId)return}else return void console.warn("Cannot parse off ping ID from pong");const a=performance.now();this._awaitingPong=!1;const i=(a-this._lastPingSent)/2;this._lastPingTimes.push(i),10<this._lastPingTimes.length&&this._lastPingTimes.shift(),r.push(...this._lastPingTimes),r.sort((e,t)=>e-t),this._pdv=r[r.length-1]-r[0];let e=0,s=r.length;4<=r.length&&6>=r.length?(++e,--s):6<r.length&&(e+=2,s-=2);let o=0;for(let n=e;n<s;++n)o+=r[n];if(this._latency=o/(s-e),r.length=0,!this._domHandler.IsHost()){const e=t.indexOf("/");if(-1<e){const n=parseFloat(t.substr(e+1));isFinite(n)?this._domHandler.AddHostTime(n,a,i,this._latency):console.warn("Invalid host time from pong response")}else console.warn("Cannot parse off host time from pong response")}}_OnMessage(t,n){const a=this._domHandler.GetSimulatedPacketLoss(),i=this._domHandler.GetSimulatedLatency(),r=this._domHandler.GetSimulatedPdv();if(!(0<a&&"u"===t&&Math.random()<a))if(0===i&&0===r)this._DoOnMessage(t,n);else{let e=1;"u"!==t&&Math.random()<a&&(e=3),setTimeout(()=>this._DoOnMessage(t,n),i*e+Math.random()*r*e)}}_DoOnMessage(e,t){if(this._wasRemoved)return;this._lastHeardFrom=performance.now(),this._domHandler.StatIncInboundCount();let n=0;if(t.data.length?n=t.data.length:t.data.byteLength&&(n=t.data.byteLength),this._domHandler.StatAddInboundBandwidthCount(n),"string"==typeof t.data){if(""===t.data.trim()||4>t.data.length)return;const e=t.data.substr(0,4);if("ping"===e)return void this.SendPong(t.data);if("pong"===e)return void this._OnPong(t.data);var i;try{i=JSON.parse(t.data)}catch(e){return this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",e),void console.log("String that failed to parse from previous error: "+t.data)}if(!i)return;try{i.c&&"m"!==i.c?this._OnControlMessage(i):this._domHandler._OnPeerMessage(this,i)}catch(e){this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",e)}return}!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===e&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(t.data)}catch(e){return this._domHandler._OnPeerError(this,e),void(this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",e))}}_OnControlMessage(e){let t,n;switch(e.c){case"disconnect":e.k&&this._domHandler.PostToRuntime("peer-kicked"),n=!this._domHandler.IsHost()&&!this.IsHost(),this.Remove(e.r),n&&this._domHandler.SignallingLeaveRoom();break;case"hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(e.hn),this._domHandler.GetSelfPeer()._SetNid(e.n),this._domHandler.SetClientDelay(e.d),this._domHandler.SetPeerUpdateRateSec(e.u),this._domHandler.MapObjectNids(e.objs),this._domHandler.MapClientValues(e.cvs));break;case"j":this._domHandler.IsHost()||(t=new s(this._domHandler,e.i,e.a),t._SetNid(e.n),this._domHandler._OnPeerOpen(t));break;case"l":this._domHandler.IsHost()||(t=this._domHandler.GetPeerById(e.i),t&&(!t.IsSelf()&&this._domHandler._OnPeerClose(t,e.r),t.Remove(e.r)));break;default:console.error("Unknown control message from peer '"+this._id+"': "+e.c),this._domHandler._OnPeerError(this,"unknown control message '"+e.c+"'");}}_OnBinaryMessage(e){this._domHandler.IsHost()?this._OnHostUpdate(e):this._OnPeerUpdate(e)}_OnHostUpdate(t){const n=new DataView(t);let i=0;const a=n.getUint32(i);if(i+=4,1664249200!==a)return void console.warn("Rejected packet with incorrect magic number (received '"+a+"', expected '"+1664249200+"'");let r=n.getFloat64(i);if(i+=8,r+=this._latency,!(3e3<=Math.abs(r-performance.now()))){n.getUint8(i),i+=1;const t=n.getUint8(i);i+=1;const s=[],o=this._domHandler.GetClientValues();for(let r=0;r<t;++r){if(r>=o.length){s.push(0);continue}const e=o[r];let t=0;switch(e.GetPrecision()){case 0:t=n.getFloat64(i),i+=8;break;case 1:t=n.getFloat32(i),i+=4;break;case 2:t=e.MaybeUnpack(n.getInt16(i)),i+=2;break;case 3:t=e.MaybeUnpack(n.getUint8(i)),i+=1;break;default:t=n.getFloat32(i),i+=4;}s.push(t)}this._AddClientUpdate(r,s)}}_AddClientUpdate(e,t){for(let n=0,a=this._clientStateUpdates.length;n<a;++n){const a=this._clientStateUpdates[n];if(a.timestamp===e)return;if(a.timestamp>e)return void this._clientStateUpdates.splice(n,0,new C3NetUpdate(e,t))}this._clientStateUpdates.push(new C3NetUpdate(e,t))}Tick(e){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>e&&this._priorUpdate&&this._priorUpdate.timestamp<e)){this._nextUpdate=null;for(let t=0,n=this._clientStateUpdates.length;t<n;++t){const n=this._clientStateUpdates[t];if(n.timestamp<=e)(!this._priorUpdate||n.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=n);else{this._nextUpdate=n;break}}}}}_OnPeerUpdate(t){const n=new DataView(t);let a=0;const i=n.getUint32(a);if(a+=4,1664249200!==i)return void console.warn("Rejected packet with incorrect magic number (received '"+i+"', expected '"+1664249200+"'");const r=n.getUint32(a);a+=4,0===r?this._HandlePeerUpdate(n,a):1===r?this._HandlePeerEvents(n,a):console.warn("Ignoring packet with incorrect flags (received "+r+", expected 0 or 1")}_HandlePeerUpdate(t,n){const a=t.getFloat64(n);n+=8;const i=t.getUint16(n);n+=2;for(let r=0;r<i;++r){const r=t.getUint16(n);n+=2;const s=t.getUint8(n);n+=1;let o=null,d=0;const l=this._domHandler.GetRegisteredObjectByNid(r);l?(o=l.GetNetValues(),d=o.length,1===s&&l._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+r);const e=t.getUint16(n);n+=2;const i=t.getUint16(n);n+=2;for(let r=0;r<e;++r){const r=t.getUint16(n);if(n+=2,l){const s=[];let e=n;for(let n=0;n<d;++n){const a=o[n];let i=0;switch(a.GetPrecision()){case 0:i=t.getFloat64(e),e+=8;break;case 1:i=t.getFloat32(e),e+=4;break;case 2:i=a.MaybeUnpack(t.getInt16(e)),e+=2;break;case 3:i=a.MaybeUnpack(t.getUint8(e)),e+=1;break;default:i=t.getFloat32(e),e+=4;}s.push(i)}l.AddUpdate(a,r,s)}n+=i}}}_HandlePeerEvents(t,n){const a=t.getFloat64(n);n+=8;const i=t.getUint16(n);n+=2;for(let r=0;r<i;++r){const i=t.getUint16(n);n+=2;const r=this._domHandler.GetRegisteredObjectByNid(i);r||console.warn("Don't know which object corresponds to NID "+ro_nid);const e=t.getUint16(n);n+=2;for(let i=0;i<e;++i){const e=t.getUint16(n);n+=2,r&&!r.HasOverriddenNids()&&(this._domHandler._OnInstanceDestroyed(r,e,a),r.RemoveObjectNid(e))}}}Remove(e,n){this._wasRemoved||(this._wasRemoved=!0,this._MaybeFireClose(e),this.Send("o",JSON.stringify({c:"disconnect",r:e,k:!!n})),t(this._dco),t(this._dcr),t(this._dcu),t(this._pc),this._dco=null,this._dcr=null,this._dcu=null,this._pc=null,this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._domHandler._RemovePeer(this))}HasClientState(e){return this._domHandler.HasClientValueTag(e)}GetClientState(e){const t=this._domHandler.GetClientValueByTag(e);if(!t)return 0;const n=t.GetIndex();if(0===this._clientStateUpdates.length)return 0;const a=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>n||n>=a.length?0:a[n]}GetInterpClientState(t){const r=t.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){const e=this._nextUpdate.data;return 0>r||r>=e.length?0:e[r]}const s=this._domHandler.GetSimulationTime();let o,d,l,_,c;if(!this._nextUpdate&&this._priorUpdate)if(this._priorUpdate2){o=this._priorUpdate2.timestamp,d=this._priorUpdate2.data[r],l=this._priorUpdate.timestamp,_=this._priorUpdate.data[r];let e=s;return e>this._priorUpdate.timestamp+250&&(e=this._priorUpdate.timestamp+250),c=n(o,l,e),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[r].GetInterp(),d,_,c,!0)}else{const e=this._priorUpdate.data;return 0>r||r>=e.length?0:e[r]}return o=this._priorUpdate.timestamp,d=this._priorUpdate.data[r],l=this._nextUpdate.timestamp,_=this._nextUpdate.data[r],c=n(o,l,s),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[r].GetInterp(),d,_,c,!1)}}self.C3Peer=s}{const t=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,n=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription,i=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate||window.msRTCIceCandidate,a=window.RTCDataChannel||window.webkitRTCDataChannel||window.mozRTCDataChannel||window.msRTCDataChannel,r=[{urls:"stun:stun.l.google.com:19302"}];let e=!1;const s=[],o=class extends DOMHandler{constructor(e){super(e,"multiplayer"),this._iceServers=[],this._sigWs=null,this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""},this._myId="",this._myAlias="",this._game="",this._gameInstance="",this._room="",this._allPeers=[],this._peersById=new Map,this._nextPeerNid=0,this._usedPeerNids=new Set,this._selfPeer=null,this._hostPeer=null,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._lastUpdateTime=0,this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundBandwidthCount:0},this._dataBuffer=new ArrayBuffer(262144),this._dataView=new DataView(this._dataBuffer),this._allRegisteredObjects=[],this._nextObjectNid=1,this._registeredObjectsByNid=new Map,this._registeredObjectsByRoId=new Map,this._simLatency=0,this._simPdv=0,this._simPacketLoss=0,this._lastTimeDiffs=[],this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._allClientValues=[],this._clientValuesByTag=new Map,this._receivedClientValues=!1,this._MergeICEServerList(r),setInterval(()=>this._DoPings(),2e3),window.addEventListener("unload",()=>this.RemoveAllPeers("quit")),this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported()),this.AddRuntimeMessageHandler("add-ice-servers",e=>this._MergeICEServerList(e.list)),this.AddRuntimeMessageHandler("simulate-latency",e=>this.SetLatencySimulation(e.latency,e.pdv,e.loss)),this.AddRuntimeMessageHandler("set-bandwidth-profile",e=>this.SetBandwidthSettings(e.updateRate,e.delay)),this.AddRuntimeMessageHandler("tick",e=>this.Tick(e)),this.AddRuntimeMessageHandler("alert",e=>this.Alert(e)),this.AddRuntimeMessageHandler("signalling-connect",e=>this.SignallingConnect(e.url)),this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect()),this.AddRuntimeMessageHandler("signalling-login",e=>this.SignallingLogin(e.alias)),this.AddRuntimeMessageHandler("signalling-join-room",e=>this.SignallingJoinGameRoom(e.game,e.instance,e.room,e.maxClients)),this.AddRuntimeMessageHandler("signalling-auto-join-room",e=>this.SignallingAutoJoinGameRoom(e.game,e.instance,e.room,e.maxClients,e.lock)),this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom()),this.AddRuntimeMessageHandler("signalling-list-game-instances",e=>this.SignallingRequestGameInstanceList(e.game)),this.AddRuntimeMessageHandler("signalling-list-rooms",e=>this.SignallingRequestRoomList(e.game,e.instance,e.which)),this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0)),this.AddRuntimeMessageHandler("peer-send-message",e=>this.OnPeerSendMessage(e)),this.AddRuntimeMessageHandler("host-broadcast",e=>this.OnHostBroadcast(e)),this.AddRuntimeMessageHandler("kick-peer",e=>this.OnKickPeer(e)),this.AddRuntimeMessageHandler("sync-object",e=>this.OnSyncObject(e)),this.AddRuntimeMessageHandler("sync-inst-var",e=>this.OnSyncInstVar(e)),this.AddRuntimeMessageHandler("associate-object",e=>this.OnAssociateObject(e)),this.AddRuntimeMessageHandler("remove-object-id",e=>this.RemoveObjectId(e.uid)),this.AddRuntimeMessageHandler("remove-net-insts",e=>this.OnRemoveNetInsts(e)),this.AddRuntimeMessageHandler("remove-object-nid",e=>this.OnRemoveObjectNid(e)),this.AddRuntimeMessageHandler("set-client-state",e=>this.SetClientState(e.tag,e.value)),this.AddRuntimeMessageHandler("add-client-input-value",e=>this.AddClientInputValue(e.tag,e.precision,e.interp))}_GetErrorMessage(e){return e?"string"==typeof e?e:"string"==typeof e.message?e.message:"string"==typeof e.details?e.details:"string"==typeof e.data?e.data:"string"==typeof e.type?e.type:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return this.IsLoggedIn()&&this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this.IsLoggedIn()?this._myId:""}GetMyAlias(){return this.IsLoggedIn()?this._myAlias:""}GetCurrentGame(){return this.IsLoggedIn()?this._game:""}GetCurrentGameInstance(){return this.IsLoggedIn()?this._gameInstance:""}GetCurrentRoom(){return this.IsInRoom()?this._room:""}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(e,t,n){var a=Math.max;this._simLatency=a(e,0),this._simPdv=a(t,0),this._simPacketLoss=a(n,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{isSupported:!!(t&&a)}}SignallingConnect(e){if(!(this._sigWs||this._isSignallingConnected)){try{this._sigWs=new WebSocket(e,"c2multiplayer")}catch(e){return this._sigWs=null,void this._OnSignallingError(e)}this._sigWs.onopen=()=>-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,void(this._isSignallingConnected=!1)):void(this._isSignallingConnected=!0),this._sigWs.onclose=()=>{this._OnSignallingClose(),this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigWs=null},this._sigWs.onerror=e=>{console.error("Signalling server error: ",e),this._OnSignallingError(e)},this._sigWs.onmessage=e=>{this._OnSignallingMessage(e)}}}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(e){let t;try{t=JSON.parse(e.data)}catch(e){return void this._OnSignallingError(e)}switch(t.message){case"welcome":this._OnSignallingReceiveWelcome(t);break;case"login-ok":this._OnSignallingReceiveLoginOK(t);break;case"join-ok":this._OnSignallingReceiveJoinOK(t);break;case"leave-ok":this._OnSignallingReceiveLeaveOK(t);break;case"kicked":this._OnSignallingReceiveKicked(t);break;case"peer-joined":this._OnSignallingReceivePeerJoined(t);break;case"peer-quit":this._OnSignallingReceivePeerQuit(t);break;case"icecandidate":this._OnSignallingReceiveIceCandidate(t);break;case"offer":this._OnSignallingReceiveOffer(t);break;case"answer":this._OnSignallingReceiveAnswer(t);break;case"instance-list":this._OnSignallingReceiveInstanceList(t);break;case"room-list":this._OnSignallingReceiveRoomList(t);break;case"error":this._OnSignallingError(t.details);break;default:this._OnSignallingError("received unknown signalling message");}}HasICEServerUrl(e){for(const t of this._iceServers)if(t.urls===e.urls)return!0;return!1}_MergeICEServerList(e){if(e)for(let t of e)"string"==typeof t&&(t={urls:t}),this.HasICEServerUrl(t)||(!t.hasOwnProperty("url")&&(t.url=t.urls),this._iceServers.push(t))}GetICEServerList(){return this._iceServers}_OnSignallingError(e){this.PostToRuntime("signalling-error",{message:this._GetErrorMessage(e)})}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(e){if(1>e.protocolrev||1<e.protocolrev)return this._OnSignallingError("signalling server protocol revision not supported"),void this.SignallingDisconnect();this._myId=e.clientid;const t=this._sigservInfo;t.protocolrev=e.protocolrev,t.version=e.version,t.name=e.name,t.operator=e.operator,t.motd=e.motd,this._MergeICEServerList(e.ice_servers),this.PostToRuntime("signalling-welcome",{myid:this._myId,sigservinfo:{protocolrev:t.protocolrev,version:t.version,name:t.name,operator:t.operator,motd:t.motd}})}_OnSignallingReceiveLoginOK(e){this._myAlias=e.alias,this._isSignallingLoggedIn=!0,this.PostToRuntime("signalling-login-ok",{myalias:this._myAlias})}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));const e=this._nextPeerNid;return this._usedPeerNids.add(e),e}}FreePeerNid(e){this.IsHost()&&this._usedPeerNids.delete(e)}_OnSignallingReceiveJoinOK(e){this.RemoveAllPeers("disconnect"),this._game=e.game,this._gameInstance=e.instance,this._room=e.room,this._selfPeer=new C3Peer(this,this._myId,this._myAlias),e.host?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._hostPeer=new C3Peer(this,e.hostid,e.hostalias),this._hostPeer.Connect()),this.PostToRuntime("signalling-join-ok",{isHost:!!e.host,hostId:this._hostPeer.GetId(),hostAlias:this._hostPeer.GetAlias(),game:this._game,gameInstance:this._gameInstance,room:this._room})}_OnSignallingReceiveLeaveOK(){this._room="",this.PostToRuntime("signalling-leave-ok")}_OnSignallingReceiveKicked(){this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked")}_OnSignallingReceivePeerJoined(e){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const t=this._peersById.get(e.peerid);t&&t.Remove("rejoin");const n=new C3Peer(this,e.peerid,e.peeralias);n.Connect()}}_OnSignallingReceivePeerQuit(e){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const t=this._peersById.get(e.id);t&&t.Remove(e.reason)}}_OnSignallingReceiveIceCandidate(e){if(this._isSignallingLoggedIn&&this._room){const t=this._peersById.get(e.from);t&&t._AddICECandidate(new i(e.icecandidate))}}_OnSignallingReceiveOffer(e){if(!this._isSignallingLoggedIn||!this._room||this.IsHost()||!this._selfPeer||!this._hostPeer||!this._hostPeer.HasPeerConnection())return;if(e.from!==this._hostPeer.GetId())return;const t=this._hostPeer.GetPeerConnection();t.setRemoteDescription(new n(e.offer)).then(()=>{t.createAnswer().then(e=>{t.setLocalDescription(e),this.SignallingSend({message:"answer",toclientid:this._hostPeer.GetId(),answer:e})}).catch(e=>{console.error("Peer error creating answer: ",e),this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(e=>{console.error("Peer error setting remote description: ",e),this._OnPeerError(this._selfPeer,"could not set remote description")})}_OnSignallingReceiveAnswer(e){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const t=this._peersById.get(e.from);t&&t.GetPeerConnection().setRemoteDescription(new n(e.answer)).catch(e=>{console.error("Host error setting remote description: ",e)})}}_OnSignallingReceiveInstanceList(e){this.PostToRuntime("signalling-instance-list",{list:e.list})}_OnSignallingReceiveRoomList(e){this.PostToRuntime("signalling-room-list",{list:e.list})}SignallingSend(e){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(e))}SignallingLogin(e){this._isSignallingLoggedIn||this.SignallingSend({message:"login",protocolrev:1,alias:e})}SignallingJoinGameRoom(e,t,n,a){!this._isSignallingLoggedIn||this._room||this.SignallingSend({message:"join",game:e,instance:t,room:n,max_clients:a})}SignallingAutoJoinGameRoom(t,n,a,i,r){!this._isSignallingLoggedIn||this._room||this.SignallingSend({message:"auto-join",game:t,instance:n,room:a,max_clients:i,lock_when_full:r})}SignallingLeaveRoom(){this._isSignallingLoggedIn&&this.SignallingSend({message:"leave"})}SignallingConfirmPeer(e){this._isSignallingLoggedIn&&this.IsHost()&&this.SignallingSend({message:"confirm-peer",id:e})}SignallingRequestGameInstanceList(e){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-instances",game:e})}SignallingRequestRoomList(e,t,n){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({message:"list-rooms",game:e,instance:t,which:n})}DisconnectRoom(e){this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this.RemoveAllPeers("disconnect"),e&&this.SignallingLeaveRoom()}_AddPeer(e){this._allPeers.push(e),this._peersById.set(e.GetId(),e),this.PostToRuntime("add-peer",{id:e.GetId(),alias:e.GetAlias()})}_RemovePeer(e){this.PostToRuntime("remove-peer",{id:e.GetId()}),this.IsHost()&&this.FreePeerNid(e.GetNid());const t=this._allPeers.indexOf(e);-1<t&&this._allPeers.splice(t,1),this._peersById.delete(e.GetId()),this._hostPeer===e&&(this._hostPeer=null,this.RemoveAllPeers("host quit")),this._selfPeer===e&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(t){if(!e){for(e=!0;this._allPeers.length;)this._allPeers[0].Remove(t);e=!1}}GetPeerById(e){return this._peersById.get(e)||null}GetAliasFromId(e){const t=this._peersById.get(e);return t?t.GetAlias():""}GetPeerByNid(e){for(const t of this._allPeers)if(t.GetNid()===e)return t;return null}OnHostBroadcast(t){const n=t.fromId,a=t.tag,i=t.message,r=t.mode,e=this.GetPeerById(n);this.HostBroadcast(r,JSON.stringify({c:"m",t:a,f:n,m:i}),e)}HostBroadcast(t,n,a){if(this.IsHost()){const i=this._allPeers.slice(0);for(const r of i)r&&r!==this._selfPeer&&r!==a&&r.Send(t,n)}}_DoPings(){const e=performance.now();if(this.IsHost()){s.push(...this._allPeers);for(const t of s)t&&t!==this._selfPeer&&t.SendPing(e,!1);s.length=0}else this._hostPeer&&this._hostPeer.SendPing(e,!1)}AddRegisteredObject(e){this._allRegisteredObjects.push(e),this._registeredObjectsByRoId.set(e.GetRoId(),e),this._registeredObjectsByNid.set(e.GetNid(),e)}GetRegisteredObjectsMap(){const e={};for(const[t,n]of this._registeredObjectsByNid.entries())e[n.GetSid()]={nid:t,nvs:n.GetNetValuesJson()};return e}MapObjectNids(e){this._registeredObjectsByNid.clear();for(const t of this._allRegisteredObjects)if(e.hasOwnProperty(t.GetSid().toString())){const n=e[t.GetSid().toString()];t._SetNid(n.nid),this._registeredObjectsByNid.set(n.nid,t),t.SetNetValuesFrom(n.nvs)}else console.warn("Could not map object SID '"+t.GetSid()+"' - host did not send NID for it"),t._SetNid(-1)}GetRegisteredObjectByNid(e){return this._registeredObjectsByNid.get(e)||null}Tick(t){if(!this.IsInRoom())return null;const n=t.dt,a=performance.now(),i=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;a-this._lastUpdateTime>=1e3/i-5&&(this.SendUpdate(a),this._lastUpdateTime=a);const r=this._stats;1e3<=a-r.lastSecondTime&&(r.outboundPerSec=r.outboundCount,r.outboundBandwidthPerSec=r.outboundBandwidthCount,r.inboundPerSec=r.inboundCount,r.inboundBandwidthPerSec=r.inboundBandwidthCount,r.outboundCount=0,r.outboundBandwidthCount=0,r.inboundCount=0,r.inboundBandwidthCount=0,r.lastSecondTime+=1e3,500<a-r.lastSecondTime&&(r.lastSecondTime=a),this.PostToRuntime("stats",{stats:{outboundPerSec:r.outboundPerSec,outboundBandwidthPerSec:r.outboundBandwidthPerSec,inboundPerSec:r.inboundPerSec,inboundBandwidthPerSec:r.inboundBandwidthPerSec}})),this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*n,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*n,this._hostTimeDiff<this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*n,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*n,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));const e=this.GetSimulationTime();for(const n of this._allPeers)n.Tick(e);for(const e of this._allRegisteredObjects)e.Tick();return{simulationTime:this.GetSimulationTime(),hostInputArrivalTime:this.GetHostInputArrivalTime(),clientDelay:this._clientDelay,peerData:this._GetPeerRuntimeData(),roData:this._GetRegisteredObjectRuntimeData(),isReadyForInput:this.IsReadyForInput()}}_GetPeerRuntimeData(){const e={};for(const t of this._allPeers){const n={};for(const e of this._allClientValues)n[e.GetTag()]=t.GetInterpClientState(e);e[t.GetId()]={nid:t.GetNid(),latency:t.GetLatency(),pdv:t.GetPdv(),clientState:n}}return e}_GetRegisteredObjectRuntimeData(){const e={};for(const t of this._allRegisteredObjects)e[t.GetRoId()]=t.GetRuntimeData();return e}async SendUpdate(e){this.IsHost()?(await this._SendHostUpdate(e),this._SendHostEvents(e)):await this._SendClientUpdate(e)}async _OnBeforeClientUpdate(){const e=await this.PostToRuntimeAsync("before-client-update");for(const t of e.clientStateUpdates)this.SetClientState(t.tag,t.value)}async _SendClientUpdate(t){if(this.IsReadyForInput()&&(await this._OnBeforeClientUpdate()),!this._selfPeer||!this._receivedClientValues)return;const n=this._dataView;let i=0;const r=this._allClientValues,s=this._selfPeer.GetLocalClientState(),e=t-this._selfPeer.GetLastStateChange(),a=t-this._selfPeer.GetLastStateTransmit();let o=!1;if(o=!!(100>e)||(1e3>e?95<=a:495<=a),!!o){n.setUint32(i,1664249200),i+=4,n.setFloat64(i,t+this._hostTimeDiff),i+=8,n.setUint8(i,0),i+=1,n.setUint8(i,r.length),i+=1;for(let e=0,t=r.length;e<t;++e){const t=r[e];let a=0;e<s.length&&(a=t.Clamp(s[e])),i=t.Write(n,i,a)}this._selfPeer._SetLastStateTransmit(t),this._hostPeer.Send("u",new Uint8Array(this._dataBuffer,0,i))}}async _SendHostUpdate(t){const n=this._dataView;let a=0,i=0;const r=await this.PostToRuntimeAsync("get-object-info",{ros:this._allRegisteredObjects.map(e=>e.GetRuntimeInfoRequest())});for(const e of this._allRegisteredObjects){const n=e.GetRoId();if(!r.hasOwnProperty(n))continue;const a=r[n];e.UpdateData(a,t),0<e.GetNumberToTransmit()&&i++}if(0!=i){n.setUint32(a,1664249200),a+=4,n.setUint32(a,0),a+=4,n.setFloat64(a,t),a+=8,n.setUint16(a,i),a+=2;for(const e of this._allRegisteredObjects)0<e.GetNumberToTransmit()&&(a=e.WriteData(n,a,t));this.HostBroadcast("u",new Uint8Array(this._dataBuffer,0,a),null)}}_SendHostEvents(e){const t=this._dataView;let n=0,a=0;for(const t of this._allRegisteredObjects)t.GetDeadNids().length&&a++;if(0!=a){t.setUint32(n,1664249200),n+=4,t.setUint32(n,1),n+=4,t.setFloat64(n,e),n+=8,t.setUint16(n,a),n+=2;for(const e of this._allRegisteredObjects){const i=e.GetDeadNids();if(i.length){t.setUint16(n,e.GetNid()),n+=2,t.setUint16(n,i.length),n+=2;for(const e of i)t.setUint16(n,e),n+=2;i.length=0}}this.HostBroadcast("r",new Uint8Array(this._dataBuffer,0,n),null)}}AddHostTime(t,n,a,i){if(this.IsHost())return;this._targetSimDelay=i+this._clientDelay;var r=t+a-n;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=r,this._simDelay=this._targetSimDelay),this._lastTimeDiffs.push(r),30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift(),s.push(...this._lastTimeDiffs),s.sort((e,t)=>e-t);let o=0,d=s.length;4<=s.length&&6>=s.length?(++o,--d):6<s.length&&19>=s.length?(o+=2,d-=2):19<s.length&&(o+=5,d-=5);let l=0;for(let r=o;r<d;++r)l+=s[r];this._targetHostTimeDiff=l/(d-o),s.length=0}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(e,t){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues){const n=this._clientValuesByTag.get(e);if(n){const e=n.GetIndex(),a=this._selfPeer.GetLocalClientState();a.length<e+1&&(a.length=e+1),a[e]!==t&&(a[e]=t,this._selfPeer._SetLastStateChange(performance.now()))}}}AddClientInputValue(e,t,n){const a=new C3NetValue(this._allClientValues.length,n,t,e,null);this._clientValuesByTag.set(e,a),this._allClientValues.push(a)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const e=[];for(const t of this._allClientValues)e.push({tag:t.GetTag(),precision:t.GetPrecision(),interp:t.GetInterp()});return e}MapClientValues(e){this._clientValuesByTag.clear(),this._allClientValues.length=0;for(let t=0,n=e.length;t<n;++t){const n=e[t],a=new C3NetValue(t,n.interp,n.precision,n.tag,null);this._clientValuesByTag.set(a.GetTag(),a),this._allClientValues.push(a)}this._receivedClientValues=!0}RemoveObjectId(e){for(const t of this._allRegisteredObjects)t.RemoveObjectId(e)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(e){return e=Math.floor(e),!this.IsInRoom()||0>e||e>=this._allPeers.length?null:this._allPeers[e]}IsReadyForInput(){return!!this.IsInRoom()&&(!!this.IsHost()||0!==this._targetHostTimeDiff)}SetBandwidthSettings(e,t){this.IsInRoom()||(this._hostUpdateRateSec=e,this._peerUpdateRateSec=e,this._clientDelay=t)}_OnPeerOpen(e){this.PostToRuntime("peer-open",{id:e.GetId(),alias:e.GetAlias()})}OnPeerSendMessage(t){const n=t.id,a=t.tag,i=t.message,r=t.mode,e=this.GetPeerById(n);e&&e.Send(r,JSON.stringify({c:"m",t:a,m:i}))}_OnPeerClose(e,t){this.PostToRuntime("peer-close",{id:e.GetId(),alias:e.GetAlias(),reason:t||"unknown"})}_OnPeerError(e,t){console.error(`[Multiplayer] Peer '${e.GetAlias()}' (${e.GetId()}) error: `,t)}_OnPeerMessage(e,t){const n=t.f||e.GetId();this.PostToRuntime("peer-message",{tag:t.t,fromId:n,fromAlias:this.GetAliasFromId(n),content:t.m})}_OnInstanceDestroyed(e,t,n){this.PostToRuntime("instance-destroyed",{roId:e.GetRoId(),nid:t,timestamp:n})}OnKickPeer(e){if(this.IsHost()){const t=e.id,n=e.reason,a=this.GetPeerById(t);a&&a.Remove(n,!0)}}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(e){this._stats.outboundBandwidthCount+=e}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(e){this._stats.inboundBandwidthCount+=e}SetClientDelay(e){this._clientDelay=e}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(e){this._peerUpdateRateSec=e}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(t){const n=t.data,i=t.precision,r=t.bandwidth;for(const s of t.objectClasses){const e=new C3RegisteredObject(this,s.roId,s.sid,r);1===n?(e.AddValue(1,i,"x"),e.AddValue(1,i,"y")):2===n?e.AddValue(2,i,"a"):3===n&&(e.AddValue(1,i,"x"),e.AddValue(1,i,"y"),e.AddValue(2,i,"a"))}}Alert(e){alert(e.message)}OnSyncInstVar(t){const n=t.precision,i=t.interp,r=t.cvt;for(const s of t.syncData){const e=this._registeredObjectsByRoId.get(s.roId);e.AddValue(i,n,"iv",s.varIndex,r)}}OnAssociateObject(t){const n=t.roId,a=t.peerId,i=t.instUid,r=this._registeredObjectsByRoId.get(n),e=this._peersById.get(a);r&&e&&(!this.IsHost()||r.OverrideNid(i,e.GetNid()))}OnRemoveNetInsts(e){for(const[t,n]of Object.entries(e)){const e=this._registeredObjectsByRoId.get(parseInt(t,10));if(e)for(const t of n)e.RemoveObjectNid(t)}}OnRemoveObjectNid(e){const t=e.roId,n=e.nid,a=this._registeredObjectsByRoId.get(t);a&&a.RemoveObjectNid(n)}};RuntimeInterface.AddDOMHandlerClass(o)}